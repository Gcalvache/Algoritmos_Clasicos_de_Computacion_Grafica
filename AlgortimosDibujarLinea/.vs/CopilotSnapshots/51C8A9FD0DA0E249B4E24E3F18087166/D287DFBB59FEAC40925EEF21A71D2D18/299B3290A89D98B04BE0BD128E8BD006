using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace AlgortimosDibujarLinea
{
    public partial class frmMetodoRecortePoligonoGreiner : Form
    {
        private List<PointF> _subject = new List<PointF>();
        private List<PointF> _clip = null;

        public frmMetodoRecortePoligonoGreiner()
        {
            InitializeComponent();
            btnCalcular.Click += BtnCalcular_Click;
            btnLimpiar.Click += BtnLimpiar_Click;
            btnSalir.Click += BtnSalir_Click;
            pcbGrafico.Image = new Bitmap(pcbGrafico.Width, pcbGrafico.Height);
            pcbGrafico.MouseClick += PcbGrafico_MouseClick;
            trkZoom.Minimum = 1; trkZoom.Maximum = 200; trkZoom.Value = 20;
            trkZoom.Scroll += (s,e) => { lblZoom.Text = $"Zoom: {trkZoom.Value} px"; Redraw(); };
            Redraw();
        }

        private void PcbGrafico_MouseClick(object sender, MouseEventArgs e)
        {
            int w = pcbGrafico.Width, h = pcbGrafico.Height; float scale = trkZoom.Value; float cx = w/2f, cy = h/2f;
            int lx = (int)Math.Round((e.X - cx)/scale); int ly = (int)Math.Round((cy - e.Y)/scale);
            _subject.Add(new PointF(lx, ly)); Redraw();
        }

        private void BtnLimpiar_Click(object sender, EventArgs e) { _subject.Clear(); _clip = null; txtXc.Clear(); txtYc.Clear(); txtR.Clear(); Redraw(); }
        private void BtnSalir_Click(object sender, EventArgs e) => Close();

        private void Redraw()
        {
            if (pcbGrafico.Image==null) pcbGrafico.Image = new Bitmap(pcbGrafico.Width, pcbGrafico.Height);
            using (Graphics g = Graphics.FromImage(pcbGrafico.Image))
            {
                g.Clear(pcbGrafico.BackColor);
                float scale = trkZoom.Value; float w = pcbGrafico.Width, h = pcbGrafico.Height; float cx = w/2f, cy = h/2f;

                // draw subject
                if (_subject.Count>0)
                {
                    var pts = _subject.Select(p => new PointF(cx + p.X*scale, cy - p.Y*scale)).ToArray();
                    if (pts.Length==1) g.FillEllipse(Brushes.Red, pts[0].X-3, pts[0].Y-3, 6,6);
                    else g.DrawPolygon(Pens.DarkGray, pts);
                }

                // clip rectangle
                var rect = new Rectangle(0,0,pcbGrafico.Width-1, pcbGrafico.Height-1); g.DrawRectangle(Pens.Blue, rect);
                float halfW = (w/2f)/scale; float halfH = (h/2f)/scale;
                _clip = new List<PointF> { new PointF(-halfW,-halfH), new PointF(halfW,-halfH), new PointF(halfW,halfH), new PointF(-halfW,halfH) };

                if (_subject.Count>=3)
                {
                    var result = CRecortePoligono.GreinerHormannClip(_subject, _clip);
                    if (result!=null && result.Count>0)
                    {
                        var rpts = result.Select(p=> new PointF(cx + p.X*scale, cy - p.Y*scale)).ToArray();
                        using (var brush = new SolidBrush(Color.FromArgb(120, 100, 200, 100))) g.FillPolygon(brush, rpts);
                        g.DrawPolygon(new Pen(Color.Green,2), rpts);
                    }
                }
            }
            pcbGrafico.Invalidate();
        }

        private void BtnCalcular_Click(object sender, EventArgs e)
        {
            if (_subject.Count<3) { MessageBox.Show("Defina al menos 3 puntos en el polígono sujeto.", "Info", MessageBoxButtons.OK, MessageBoxIcon.Information); return; }
            Redraw();
        }
    }
}
